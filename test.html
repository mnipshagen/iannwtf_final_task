<!doctype html>
<html lang="en" dir="ltr">

    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Recipe Generation Evaluation</title>
        <link rel="stylesheet" href="css/foundation.css">
        <link rel="stylesheet" href="css/app.css">
    </head>

    <body>
        <div class="grid-container">
            
            <div class="grid-x grid-padding-x">
                <div class="large-9 cell">
                    <h1>Wurde das Rezept von einem Menschen zusammengestellt?</h1>
                </div>
            </div>
    
            <div class="grid-x grid-padding-x">
                <div class="large-3 medium-3 cell">
                    <div style="margin: 0 auto;">
                        <h3>Klick mich!</h3>
                        <div style="height: 20%;">
                            <input type="button" value="Jawohl!" class="success button" onclick="chosen('yes');" style="width: 50%;" />    
                        </div>
                        <div style="height: 20%;">
                            <input type="button" value="Nein!" class="alert button" onclick="chosen('no');" style="width: 50%;" />
                        </div>
                    </div>
                </div>
                <div class="large-3 medium-3 cell">
                    <h3>Zutaten</h3>
                    <ul id="ingredientlist">
                    </ul>
                </div>
                <div class="large-3 medium-3 cell">
                    <h3>Auswertung</h3>
                    Alle 8 Rezepte aktualisiert sich die Auswertung um zu vermeiden, dass du weißt welches der Rezepte du richtig oder falsch ausgewählt hast.
                    <hr>
                    <div>
                        Rezepte ausgewertet: <b><span id="recipe_count" style="text-align: right;">0</span></b><br>
                        Davon korrekt : <b><span id="recipe_count_correct" style="text-align: right;">0</span></b>
                    </div>
                </div>
            </div>
        </div>


        <!-- Initialise Firebase connection -->
        <script src="https://www.gstatic.com/firebasejs/4.9.0/firebase.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.9.1/firebase-firestore.js"></script>
        <script>
            // Initialize Firebase
            var config = {
                apiKey: "AIzaSyBH8U4Muui1-pZIirv1UbxLmA8muJzPjEY",
                authDomain: "ainnwtf.firebaseapp.com",
                databaseURL: "https://ainnwtf.firebaseio.com",
                projectId: "ainnwtf",
                storageBucket: "ainnwtf.appspot.com",
                messagingSenderId: "770019981294"
            };
            firebase.initializeApp(config);
        </script>

        <!-- Foundations scripts? -->
        <script src="js/vendor/jquery.js"></script>
        <!-- <script src="js/vendor/what-input.js"></script> -->
        <script src="js/vendor/foundation.min.js"></script>
        <script src="js/app.js"></script>
        <!-- That bad shit I wrote out -->
        <script>
            // const firebase = require("firebase");
            // Required for side-effects
            // require("firebase/firestore");

            const db = firebase.firestore();
            const recipes = db.collection("recipes");

            let active_doc = null;
            const list = $('#ingredientlist');
            let count = 0;
            let count_correct = 0;

            function failed(){
                active_doc = null;
                list.empty();
                list.append($( '<li>', {
                    text: "Something went wrong. Sorry for that. Press any of the two buttons to try again."
                }));
            }
            function show_new(doc){
                active_doc = doc;
                let data = doc.data();
                list.empty();
                data.ingredients.forEach(function (ing) {
                    if (ing != "NO_INGREDIENT"){
                        list.append($('<li>', {
                            text: ing
                        }));
                    }
                });
            }
            function chosen(str){
                let action = (str == 'yes');
                if (active_doc != null){
                    let data = active_doc.data();
                    let update = {};
                    if (data.real != action){
                        let incorrect = parseInt(data.incorrect) + 1;
                        update = {"incorrect": incorrect};
                    } else {
                        let correct = parseInt(data.correct) + 1;
                        update = {"correct": correct};
                        count_correct += 1;
                    }
                    count += 1;
                    if (count % 8 == 0){
                        $( '#recipe_count' ).text(count);
                        $( '#recipe_count_correct' ).text(count_correct);
                    }
                    let docRef = recipes.doc(active_doc.id);
                    docRef.update(update);
                }
                new_one();
            }
            function new_one(){
                rnd = parseInt((Math.random() * 250000), 10)
                recipes.where("random", ">", rnd).orderBy("random").limit(1)
                .get()
                .then(function (snapshot) {
                    if (snapshot.empty) {
                        recipes.where("random", "<=", rnd).orderBy.orderBy("random", "desc").limit(1)
                        .get()
                        .then(function (snap) {
                            if (snap.empty){
                                failed();
                            } else {
                                doc = snap.docs[0];
                                show_new(doc);
                            }
                        })
                        .catch(function (error) {
                            console.log("oops. " + error);
                            failed();
                        })
                    } else {
                        doc = snapshot.docs[0];
                        show_new(doc);
                    }
                })
                .catch(function (error) {
                    console.log("oops. " + error);
                    failed();
                })
            }

            window.onload = new_one();
            
        </script>
    
    </html>